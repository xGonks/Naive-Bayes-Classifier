---
title: "scrap"
author: "Todos"
format:
   html:
     toc: true
     html-math-method: katex
     embed-resources: true
     self-contained-math: true
     df-print: kable
editor: visual
---

```{r}
library(robotstxt)
library(rvest)
library(httr)
library(tibble)
library(stringr)
library(furrr)
library(dplyr)
```

```{r}
paths_allowed("https://www.yourghoststories.com/")
```

```{r}
page = read_html("https://www.yourghoststories.com/real-ghost-story.php?story=1")

prueba = page %>%
  html_nodes(".storyinfo a") %>% # .storyinfo a # #story # #story p
  html_text()

prueba
```

```{r}
page = read_html("https://www.yourghoststories.com/real-ghost-stories.php")

categorias = page %>%
  html_nodes(".two_column_layout_col") %>%
  html_text() %>%
  str_split("\n") %>%
  unlist() %>%
  str_trim() %>%
  .[. != ""] %>%
  str_remove("\\s*\\(\\d+\\)$")

categorias
```

```{r}
paises = page %>%
  html_nodes(".column_layout:nth-child(53) .three_column_layout_col") %>%
  html_text() %>%
  str_split("\n") %>%
  unlist() %>%
  str_trim() %>%
  .[. != ""] %>%
  str_remove("\\s*\\(\\d+\\)$")

paises
```

```{r}
estados = page %>%
  html_nodes(".column_layout:nth-child(55) .three_column_layout_col") %>%
  html_text() %>%
  str_split("\n") %>%
  unlist() %>%
  str_trim() %>%
  .[. != ""] %>%
  str_remove("\\s*\\(\\d+\\)$")

estados
```

```{r}
detectar_valor <- function(texto, lista) {
  encontrado <- lista[str_detect(texto, fixed(lista, ignore_case = TRUE))]
  if (length(encontrado) > 0) {
    return(encontrado[1])
  } else {
    return(NA_character_)
  }
}
```

```{r}
plan(multisession, workers = 4)

get_story <- function(x, paises, estados, categorias) {
  url <- sprintf("https://www.yourghoststories.com/real-ghost-story.php?story=%d", x)
  
  tryCatch({
    resp <- GET(url)
    if (status_code(resp) != 200) return(NULL)
    
    page <- read_html(resp)
    
    title <- page %>%
      html_node(".storytitle") %>%
      html_text(trim = TRUE)
    
    description <- page %>%
      html_node("#story") %>%
      html_text(trim = TRUE)
    
    info_extra <- page %>%
      html_nodes(".storyinfo a") %>%
      html_text(trim = TRUE)
    
    country <- intersect(info_extra, paises)[1] %||% NA
    state   <- intersect(info_extra, estados)[1] %||% NA
    category<- intersect(info_extra, categorias)[1] %||% NA
    
    list(
      id = x,
      title = title,
      country = country,
      state = state,
      category = category,
      description = gsub("\n", " ", description)
    )
  }, error = function(e) NULL)
}

results <- future_map(1:20124, ~ get_story(.x, paises, estados, categorias), .progress = TRUE)

data_pages <- bind_rows(results)

data_pages
```

```{r}
write.table(
  data_pages,
  file = "../data/data_pages.csv",
  sep = "#$%#$%",
  row.names = FALSE,
  col.names = TRUE,
  quote = TRUE,
  fileEncoding = "UTF-8"
)
```

```{r}
lines <- readLines("../data/data_pages.csv", encoding = "UTF-8")
split_lines <- strsplit(lines, "#\\$%#\\$%")

data_pages_loaded <- as.data.frame(do.call(rbind, split_lines), stringsAsFactors = FALSE)

colnames(data_pages_loaded) <- data_pages_loaded[1, ]
data_pages_loaded <- data_pages_loaded[-1, ]
rownames(data_pages_loaded) <- NULL

data_pages_loaded
```

```{r}

```
